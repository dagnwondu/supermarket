{% extends 'doctor_page/doctor_base.html' %} {% block content %}
<style>
  p {
    text-align: center;
  }
</style>
<div class="container">
  <!-- Patient Information -->
  <div class="card mb-4 shadow-lg">
    <div class="card-header bg-dark text-white text-center fw-bold">
      <i class="fas fa-user-md"></i> Patient Information
    </div>
    <div class="card-body">
      <h4 class="card-title text-center text-primary fw-bold">
        {{ patient.full_name }}
      </h4>
      <hr />
      <div class="row text-center">
        <!-- Left Column -->
        <div class="col-md-6 mb-2">
          <p class="card-text">
            <i class="fas fa-birthday-cake text-danger"></i>
            <strong>Age:</strong> {{ patient.age }}
          </p>
          <p class="card-text">
            <i class="fas fa-venus-mars text-info"></i>
            <strong>Gender:</strong> {{ patient.gender }}
          </p>
        </div>
        <!-- Right Column -->
        <div class="col-md-6">
          <p class="card-text">
            <i class="fas fa-clock text-warning"></i>
            <strong>Time Assigned:</strong> {{ time_assigned }}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Vitals Section -->
  <div class="card mb-3">
    <div class="card-header bg-info text-white text-center">Vitals</div>
    <div class="card-body">
      {% if medical_record.vitals %}
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Vital</th>
            <th>Value</th>
            <th>Unit</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th>Temperature</th>
            <td>{{ medical_record.vitals.temperature }}</td>
            <td>Â°C</td>
          </tr>
          <tr>
            <th>Blood Pressure</th>
            <td>{{ medical_record.vitals.blood_pressure }}</td>
            <td>mmHg</td>
          </tr>
          <tr>
            <th>Heart Rate</th>
            <td>{{ medical_record.vitals.heart_rate }}</td>
            <td>bpm</td>
          </tr>
          <tr>
            <th>Respiratory Rate</th>
            <td>{{ medical_record.vitals.respiratory_rate }}</td>
            <td>breaths/min</td>
          </tr>
          <tr>
            <th>Oxygen Saturation</th>
            <td>{{ medical_record.vitals.oxygen_saturation_with_oxygen }}</td>
            <td>%</td>
          </tr>
          <tr>
            <th>Oxygen Saturation</th>
            <td>{{ medical_record.vitals.oxygen_saturation_no_oxygen }}</td>
            <td>%</td>
          </tr>
          <tr>
            <th>Blood Glucose</th>
            <td>{{ medical_record.vitals.blood_glucose }}</td>
            <td>mg/dL</td>
          </tr>
          <tr>
            <th>Recorded Time</th>
            <td colspan="2">{{ medical_record.vitals.recorded_at }}</td>
          </tr>
        </tbody>
      </table>
      {% elif medical_record.vitals_status == "Pending" %}
      <p>
        <strong>Status:</strong>
        <span class="badge bg-warning">Not Assigned</span>
      </p>
      {% else %}
      <p>
        <strong>Status:</strong>
        <span class="badge bg-secondary">Not Assigned</span>
      </p>
      <form method="POST" action="{% url 'assign_vitals' patient.id %}">
        {% csrf_token %}
        <button
          type="submit"
          class="btn btn-info"
          {%
          if
          medical.history_taking_status
          !="Completed"
          %}disabled{%
          endif
          %}
        >
          Assign Vitals Check
        </button>
      </form>
      {% endif %}
    </div>
  </div>

  <!-- History Taking Status -->
  <div class="card mb-3">
    <div class="card-header bg-dark text-white text-center">History Taking</div>
    <div class="card-body">
      {% if medical_record.historytaking %}
      <p>
        <strong>Status:</strong> <span class="badge bg-success">Completed</span>
      </p>
      <table class="table table-bordered">
        <thead class="table-dark">
          <tr>
            <th>Chief Complain</th>
            <th>History of Present Illness (HPI)</th>
            <th>History Of Past Illness</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>{{ medical_record.historytaking.chief_complain }}</td>
            <td>{{ medical_record.historytaking.hpi }}</td>
            <td>{{ medical_record.historytaking.history_of_past_illness }}</td>
          </tr>
        </tbody>
      </table>

      {% else %}
      <p>
        <strong>Status:</strong> <span class="badge bg-warning">Pending</span>
      </p>

      <!-- Add History Taking Form -->
      <form
        method="POST"
        action="{% url 'complete_history_taking' patient.id %}"
      >
        {% csrf_token %}
        <div class="mb-3">
          <label for="chief_complain" class="form-label">Chief Complaint</label>
          <textarea
            name="chief_complain"
            id="chief_complain"
            class="form-control"
            rows="2"
            placeholder="Enter chief complaint..."
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="hpi" class="form-label"
            >History of Present Illness (HPI)</label
          >
          <textarea
            name="hpi"
            id="hpi"
            class="form-control"
            rows="4"
            placeholder="Enter HPI..."
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="hpasti" class="form-label"
            >History of Past Illness
          </label>
          <textarea
            name="hpasti"
            id="hpasti"
            class="form-control"
            rows="4"
            placeholder="Enter Hpast..."
          ></textarea>
        </div>
        <button type="submit" class="btn btn-dark">
          Save History Taking Notes
        </button>
      </form>
      {% endif %}
    </div>
  </div>

  <!-- Physical Examination Status -->
  <div class="card mb-3">
    <div class="card-header bg-dark text-white text-center">
      Physical Examination
    </div>
    <div class="card-body">
      {% if medical_record.physicalexamination %}
      <p>
        <strong>Status:</strong> <span class="badge bg-success">Completed</span>
      </p>
      <table class="table table-bordered">
        <thead class="table-dark">
          <tr>
            <th>Category</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>General Appearance</strong></td>
            <td>{{ medical_record.physicalexamination.general_appearance }}</td>
          </tr>
          <tr>
            <td><strong>HEENT</strong></td>
            <td>{{ medical_record.physicalexamination.heent }}</td>
          </tr>
          <tr>
            <td><strong>LGS</strong></td>
            <td>{{ medical_record.physicalexamination.lgs }}</td>
          </tr>
          <tr>
            <td><strong>Chest</strong></td>
            <td>{{ medical_record.physicalexamination.chest }}</td>
          </tr>
          <tr>
            <td><strong>CVS</strong></td>
            <td>{{ medical_record.physicalexamination.cvs }}</td>
          </tr>
          <tr>
            <td><strong>Abdomen</strong></td>
            <td>{{ medical_record.physicalexamination.abdomen }}</td>
          </tr>
          <tr>
            <td><strong>GUS</strong></td>
            <td>{{ medical_record.physicalexamination.gus }}</td>
          </tr>
          <tr>
            <td><strong>MSS</strong></td>
            <td>{{ medical_record.physicalexamination.mss }}</td>
          </tr>
          <tr>
            <td><strong>CNS</strong></td>
            <td>{{ medical_record.physicalexamination.cns }}</td>
          </tr>
        </tbody>
      </table>
      {% else %}
      <p>
        <strong>Status:</strong> <span class="badge bg-warning">Pending</span>
      </p>

      <!-- Add Physical Examination -->
      <form
        method="POST"
        action="{% url 'complete_physical_examination' patient.id %}"
      >
        {% csrf_token %}
        <div class="mb-3">
          <label for="general_appearance" class="form-label"
            >General Appearance</label
          >
          <textarea
            name="general_appearance"
            id="general_appearance"
            class="form-control"
            rows="2"
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="heent" class="form-label">HEENT</label>
          <textarea
            name="heent"
            id="heent"
            class="form-control"
            rows="2"
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="lgs" class="form-label">LGS</label>
          <textarea
            name="lgs"
            id="lgs"
            class="form-control"
            rows="2"
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="chest" class="form-label">Chest</label>
          <textarea
            name="chest"
            id="chest"
            class="form-control"
            rows="2"
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="cvs" class="form-label">CVS</label>
          <textarea
            name="cvs"
            id="cvs"
            class="form-control"
            rows="2"
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="abdomen" class="form-label">Abdomen</label>
          <textarea
            name="abdomen"
            id="abdomen"
            class="form-control"
            rows="2"
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="gus" class="form-label">GUS</label>
          <textarea
            name="gus"
            id="gus"
            class="form-control"
            rows="2"
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="mss" class="form-label">MSS</label>
          <textarea
            name="mss"
            id="mss"
            class="form-control"
            rows="2"
          ></textarea>
        </div>
        <div class="mb-3">
          <label for="cns" class="form-label">CNS</label>
          <textarea
            name="cns"
            id="cns"
            class="form-control"
            rows="2"
          ></textarea>
        </div>
        <button type="submit" class="btn btn-dark">
          Save Physical Examination
        </button>
      </form>
      {% endif %}
    </div>
  </div>

  <!-- Diagnosis -->
  <div class="card mb-3">
    <div class="card-header bg-dark text-white text-center">
      Diagnosis Taking
    </div>
    <div class="card-body">
      <form
        method="POST"
        action="{% url 'complete_diagnosis' medical_record.patient.id %}"
      >
        {% csrf_token %}

        <div class="mb-3">
          <label for="complete_diagnosis" class="form-label"
            >Write Diagnosis</label
          >
          <textarea
            name="complete_diagnosis"
            id="complete_diagnosis"
            class="form-control"
            rows="2"
          >
{{ medical_record.diagnosis }}</textarea
          >
        </div>
        <button type="submit" class="btn btn-dark">Save Diagnosis</button>
      </form>
    </div>
  </div>









  
  <!-- Test Taking -->
  <div class="card mb-3">
    <div class="card-header bg-primary text-white"> Services</div>
    <div class="card-body">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Test Name</th>
            <th>Payment Status</th>
            <th>Result/Service Status</th>
          </tr>
        </thead>
        <tbody>
          {% for item in payments %}
          <tr>
            
            <td><strong>{{ item.service_type.name }}</strong></td>
            <td><strong>{{ item.status }}</strong></td>
            <td><strong>{{ item.service_type.service_status }}</strong></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <!-- Order Test Form -->
      <form method="POST" action="{% url 'assign_service' patient.id %}">
        {% csrf_token %}

        <div class="mb-3">
          <label for="service_category" class="form-label"
            >Select Service Category</label
          >
          <select
            name="service_category"
            id="service_category"
            class="form-select"
            required
          >
            <option value="">Choose Category</option>
            {% for category in service_categories %}
            <option value="{{ category.id }}">{{ category.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label for="services" class="form-label"
            >Select Service</label
          >
          <select
            name="service"
            id="services"
            class="form-select"
            required
          >
            <option value="">Choose a Service</option>
            <!-- Options will be dynamically loaded based on selected category -->
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Assign Service</button>
      </form>

</div>
</div>

      <a href="{% url 'doctor_page' %}" class="btn btn-secondary"
        >Back to Dashboard</a
      >
    </div>

    <!-- JavaScript for dynamic category-test filtering -->

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const categorySelect = document.getElementById("service_category");
        const serviceSelect = document.getElementById("services");

        categorySelect.addEventListener("change", function () {
          const categoryId = categorySelect.value;

          // Disable Service dropdown and reset options
          serviceSelect.innerHTML = '<option value="">Choose a service</option>';
          serviceSelect.disabled = true; // Disable the dropdown while loading

          if (categoryId) {
            // Show loading indication (optional)
            serviceSelect.innerHTML = "<option>Loading...</option>";

            fetch(`/patient/get_services_by_category/${categoryId}/`) // Ensure correct URL pattern
              .then((response) => response.json())
              .then((data) => {
                if (data.services && data.services.length > 0) {
                  data.services.forEach((service) => {
                    const option = document.createElement("option");
                    option.value = service.id;
                    option.textContent = service.name;
                    serviceSelect.appendChild(option);
                  });
                  serviceSelect.disabled = false; // Enable the dropdown after loading
                } else {
                  serviceSelect.innerHTML = "<option>No services available</option>";
                  serviceSelect.disabled = true; // Disable if no services found
                }
              })
              .catch((error) => {
                console.error("Error fetching services:", error);
                serviceSelect.innerHTML = "<option>Error loading services</option>";
                serviceSelect.disabled = true; // Disable dropdown if error
              });
          }
        });
      });
    </script>

    {% endblock %}
  </div>
</div>
