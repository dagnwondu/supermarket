{% extends 'base.html' %}

{% block content %}
<div class="card card-simple p-4">
    <h4>Add Sale</h4>
    <form method="POST">
        {% csrf_token %}

        <div class="mb-3">
            <label>Product</label>
            <input type="text" id="product_input" class="form-control" placeholder="Type product name or category" autocomplete="off" required>
            <input type="hidden" name="product_id" id="product_id">
        </div>

        <div class="mb-3">
            <label>Available Quantity</label>
            <input type="number" id="available_qty" class="form-control" readonly>
        </div>

        <div class="mb-3">
            <label>Price</label>
            <input type="number" step="0.01" name="price" id="price" class="form-control" readonly>
        </div>

        <div class="mb-3">
            <label>Quantity to Sell</label>
            <input type="number" name="quantity" id="quantity" class="form-control" required>
        </div>

        <button class="btn btn-primary"><i class="bi bi-bag-plus"></i> Add Sale</button>
    </form>

    <!-- Suggestions Dropdown -->
    <ul class="list-group mt-1" id="suggestions" style="position:absolute; z-index:1000;"></ul>

</div>

<script>
const input = document.getElementById('product_input');
const suggestions = document.getElementById('suggestions');
const productId = document.getElementById('product_id');
const priceField = document.getElementById('price');
const availableQty = document.getElementById('available_qty');

input.addEventListener('input', async () => {
    const query = input.value;
    if (query.length < 1) {
        suggestions.innerHTML = '';
        return;
    }

const res = await fetch("{% url 'product_search' %}?q=" + query);
    const data = await res.json();

    suggestions.innerHTML = '';
    data.forEach(item => {
        const li = document.createElement('li');
        li.classList.add('list-group-item', 'list-group-item-action');
        li.textContent = `${item.name} | ${item.category} | ${item.quantity} in stock`;
        li.addEventListener('click', () => {
            input.value = item.name;
            productId.value = item.id;
            priceField.value = item.selling_price;
            availableQty.value = item.quantity;
            suggestions.innerHTML = '';
        });
        suggestions.appendChild(li);
    });
});
</script>
{% endblock %}
