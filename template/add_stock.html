{% extends 'base.html' %}

{% block content %}
<div class="card card-simple p-4" style="max-width: 600px; margin:auto;">
    <h4>Add Stock</h4>
        <!-- Messages -->
    {% if messages %}
    <div class="mb-3">
        {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <form method="POST">
        {% csrf_token %}

        <div class="mb-3 position-relative">
            <label>Product</label>
            <input type="text" id="product_input" class="form-control" placeholder="Type product name or category" autocomplete="off" required>
            <input type="hidden" name="product_id" id="product_id">
            <ul class="list-group" id="suggestions" style="position:absolute; z-index:1000; width:100%;"></ul>
        </div>

        <div class="mb-3">
            <label>Current Quantity</label>
            <input type="number" id="current_qty" class="form-control" readonly>
        </div>

        <div class="mb-3">
            <label>Quantity to Add</label>
            <input type="number" name="quantity" class="form-control" min="1" required>
        </div>

        <div class="mb-3">
            <label>Buying Price</label>
            <input type="number" step="0.01" name="buying_price" id="buying_price" class="form-control" required>
        </div>

        <div class="mb-3">
            <label>Selling Price</label>
            <input type="number" step="0.01" name="selling_price" id="selling_price" class="form-control" required>
        </div>

        <div class="mb-3">
            <label>Expiry Date</label>
            <input type="date" name="expiry_date" id="expiry_date" class="form-control">
        </div>

        <button class="btn btn-primary w-100"><i class="bi bi-plus-circle"></i> Add Stock</button>
    </form>
</div>

<script>
const input = document.getElementById('product_input');
const suggestions = document.getElementById('suggestions');
const productId = document.getElementById('product_id');
const currentQty = document.getElementById('current_qty');
const buyingPrice = document.getElementById('buying_price');
const sellingPrice = document.getElementById('selling_price');
const expiryDate = document.getElementById('expiry_date');

input.addEventListener('input', async () => {
    const query = input.value.trim();
    if (!query) {
        suggestions.innerHTML = '';
        return;
    }

    const res = await fetch("{% url 'product_search' %}?q=" + query);
    const data = await res.json();

    suggestions.innerHTML = '';
    data.forEach(item => {
        const li = document.createElement('li');
        li.classList.add('list-group-item', 'list-group-item-action');
        li.innerHTML = `
            ${item.name} | ${item.category} | ${item.quantity} in stock
            ${item.low_stock ? '<span class="badge bg-warning text-dark ms-2">Low Stock</span>' : ''}
        `;
        li.addEventListener('click', () => {
            input.value = item.name;
            productId.value = item.id;
            currentQty.value = item.quantity;
            sellingPrice.value = item.selling_price || '';
            buyingPrice.value = item.buying_price || '';
            expiryDate.value = item.expiry_date || '';
            suggestions.innerHTML = '';
        });
        suggestions.appendChild(li);
    });
});

// Hide suggestions when clicking outside
document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !suggestions.contains(e.target)) {
        suggestions.innerHTML = '';
    }
});
</script>
{% endblock %}
