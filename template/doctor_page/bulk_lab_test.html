{% extends 'doctor_page/doctor_base.html' %} {% block content %}
<div class="container mt-4">
  <div class="card p-4 shadow-sm bg-dark text-white rounded">
    <form
      action="{% url 'submit_bulk_services' patient.id %}"
      method="POST"
      id="order-form"
    >
      {% csrf_token %}

      <!-- Patient Info -->
      <div class="container mb-3">
        <h5>Order Investigations for {{ patient }}</h5>
      </div>
      <!-- Selected Investigation Display -->
      <div class="mt-4">
        <h5>Selected Investigation:</h5>
        <div
          id="selected-services-badges"
          class="d-flex flex-wrap gap-2 mt-2"
        ></div>
      </div>

      <!-- Tests and Investigation -->
      <div class="mb-3">
        <div class="border p-3 rounded">
          <div class="row">
            <!-- Laboratory Tests -->
            <div class="col-md-4">
              <h5>Laboratory Tests</h5>
              {% for service in lab_tests %}
              <div class="form-check">
                <input
                  class="form-check-input service-checkbox"
                  type="checkbox"
                  name="selected_services"
                  value="{{ service.name }}"
                  id="labTest{{ forloop.counter }}"
                />
                <label
                  class="form-check-label"
                  for="labTest{{ forloop.counter }}"
                >
                  {{ service.name }}
                </label>
              </div>
              {% endfor %}
            </div>

            <!-- Imaging Tests -->
            <div class="col-md-4">
              <h5>Imaging Tests</h5>
              {% for service in imaging_tests %}
              <div class="form-check">
                <input
                  class="form-check-input service-checkbox"
                  type="checkbox"
                  name="selected_services"
                  value="{{ service.name }}"
                  id="imagingTest{{ forloop.counter }}"
                />
                <label
                  class="form-check-label"
                  for="imagingTest{{ forloop.counter }}"
                >
                  {{ service.name }}
                </label>
              </div>
              {% endfor %}
            </div>

            <!-- Other Services -->
            <div class="col-md-4">
              <h5>Other Services</h5>
              {% for service in other_services %}
              <div class="form-check">
                <input
                  class="form-check-input service-checkbox"
                  type="checkbox"
                  name="selected_services"
                  value="{{ service.name }}"
                  id="otherTest{{ forloop.counter }}"
                />
                <label
                  class="form-check-label"
                  for="otherTest{{ forloop.counter }}"
                >
                  {{ service.name }}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary">Submit</button>
      </div>
    </form>
  </div>
</div>

<!-- JavaScript for dynamic badge handling -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    function updateSelectedServices() {
      const checkboxes = document.querySelectorAll(".service-checkbox:checked");
      const selectedServices = Array.from(checkboxes).map((cb) => ({
        id: cb.value,
        name: cb.nextElementSibling.textContent.trim(),
      }));

      const badges = document.getElementById("selected-services-badges");
      badges.innerHTML = "";

      selectedServices.forEach((service) => {
        const badge = document.createElement("span");
        badge.className = "badge bg-primary p-2";
        badge.textContent = service.name;

        const removeBtn = document.createElement("button");
        removeBtn.innerHTML = "&times;";
        removeBtn.className = "btn btn-sm btn-danger ms-2 py-0 px-2";
        removeBtn.onclick = () => uncheckService(service.id);

        const wrapper = document.createElement("div");
        wrapper.className = "d-inline-flex align-items-center";
        wrapper.appendChild(badge);
        wrapper.appendChild(removeBtn);

        badges.appendChild(wrapper);
      });
    }

    function uncheckService(serviceName) {
      const checkboxes = document.querySelectorAll(".service-checkbox");
      checkboxes.forEach((cb) => {
        if (cb.value === serviceName) cb.checked = false;
      });
      updateSelectedServices();
    }

    // Init
    updateSelectedServices();
    document.querySelectorAll(".service-checkbox").forEach((cb) => {
      cb.addEventListener("change", updateSelectedServices);
    });
  });
</script>
{% endblock %}
